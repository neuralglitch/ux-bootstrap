{% apply spaceless -%}

  {% set o = this.options() %}

  <div class="{{ o.wrapperClasses }}" {{ this.renderHtmlAttributes(o.wrapperAttrs) | raw }}>
    
    {# Toggle Button #}
    <button 
      class="{{ o.toggleClasses }}" 
      {{ this.renderHtmlAttributes(o.toggleAttrs) | raw }}
      data-bs-dropdown-multi-target="toggle"
    >
      <span data-bs-dropdown-multi-target="label">{{ o.buttonLabel }}</span>
    </button>

    {# Dropdown Menu #}
    <div class="{{ o.menuClasses }}" {{ this.renderHtmlAttributes(o.menuAttrs) | raw }}>
      
      {# Search Input #}
      {% if o.searchable %}
        <div class="px-3 py-2">
          <input 
            type="text" 
            class="form-control form-control-sm" 
            placeholder="{{ o.searchPlaceholder }}"
            data-bs-dropdown-multi-target="search"
            data-action="input->bs-dropdown-multi#search"
            autocomplete="off"
          >
        </div>
        <hr class="dropdown-divider">
      {% endif %}

      {# Select All / Clear Actions #}
      {% if o.showSelectAll or o.showClear %}
        <div class="px-3 py-1 d-flex justify-content-between gap-2">
          {% if o.showSelectAll %}
            <button 
              type="button" 
              class="btn btn-link btn-sm text-decoration-none p-0"
              data-action="click->bs-dropdown-multi#selectAll"
            >
              {{ o.selectAllLabel }}
            </button>
          {% endif %}
          {% if o.showClear %}
            <button 
              type="button" 
              class="btn btn-link btn-sm text-decoration-none p-0"
              data-action="click->bs-dropdown-multi#clearAll"
            >
              {{ o.clearLabel }}
            </button>
          {% endif %}
        </div>
        <hr class="dropdown-divider">
      {% endif %}

      {# Options List #}
      <div 
        class="px-3 py-2" 
        data-bs-dropdown-multi-target="optionsList"
        style="max-height: {{ o.maxHeight }}; overflow-y: auto;"
      >
        {% for option in o.options %}
          <div 
            class="form-check{% if option.disabled|default(false) %} opacity-50{% endif %}"
            data-bs-dropdown-multi-target="option"
            data-option-value="{{ option.value }}"
            data-option-label="{{ option.label }}"
          >
            <input 
              class="form-check-input" 
              type="checkbox" 
              value="{{ option.value }}" 
              id="dropdown-multi-{{ o.name }}-{{ loop.index }}"
              {% if option.selected|default(false) %}checked{% endif %}
              {% if option.disabled|default(false) %}disabled{% endif %}
              data-bs-dropdown-multi-target="checkbox"
              data-action="change->bs-dropdown-multi#updateSelection"
              {% if o.name %}name="{{ o.name }}[]"{% endif %}
            >
            <label 
              class="form-check-label w-100 user-select-none" 
              for="dropdown-multi-{{ o.name }}-{{ loop.index }}"
              style="cursor: pointer;"
            >
              {{ option.label }}
              {% if option.description|default(null) %}
                <small class="d-block text-muted">{{ option.description }}</small>
              {% endif %}
            </label>
          </div>
        {% endfor %}
      </div>

      {# Apply Button #}
      {% if o.showApply %}
        <hr class="dropdown-divider">
        <div class="px-3 py-2">
          <button 
            type="button" 
            class="btn btn-primary btn-sm w-100"
            data-action="click->bs-dropdown-multi#apply"
          >
            {{ o.applyLabel }}
          </button>
        </div>
      {% endif %}

      {# No Results Message (hidden by default, shown by JS when search has no results) #}
      <div 
        class="px-3 py-2 text-muted text-center d-none" 
        data-bs-dropdown-multi-target="noResults"
      >
        No results found
      </div>
    </div>
  </div>

{%- endapply %}

