{% apply spaceless -%}
  {% set o = this.options() %}
  
  {# Main controller wrapper #}
  <div {{ this.renderHtmlAttributes(o.controllerAttrs) | raw }}>
  
  {# Wrapper container #}
  {% if o.containerClasses %}
    <div class="{{ o.containerClasses }}">
  {% endif %}

  {# Search and controls bar #}
  {% if o.sortable or o.selectable %}
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div class="flex-grow-1 me-3" style="max-width: 300px;">
        <input 
          type="search" 
          class="form-control" 
          placeholder="Search..." 
          data-bs-data-table-target="search"
          data-action="input->bs-data-table#search"
        >
      </div>
      <div class="text-muted small" data-bs-data-table-target="info"></div>
    </div>
  {% endif %}

  {# Optional card wrapper #}
  {% if o.cardWrapper %}
    <div class="card{{ o.wrapperClasses ? ' ' ~ o.wrapperClasses : '' }}">
      {% if o.cardTitle or o.cardSubtitle %}
        <div class="card-header">
          {% if o.cardTitle %}
            <h5 class="card-title mb-0">{{ o.cardTitle }}</h5>
          {% endif %}
          {% if o.cardSubtitle %}
            <p class="card-subtitle text-muted mt-1 mb-0">{{ o.cardSubtitle }}</p>
          {% endif %}
        </div>
      {% endif %}
      <div class="card-body{{ o.isEmpty and o.showEmptyState ? ' p-0' : '' }}">
  {% elseif o.wrapperClasses %}
    <div class="card{{ o.wrapperClasses }}">
  {% endif %}

  {# Responsive wrapper #}
  {% if o.responsiveClass %}
    <div class="{{ o.responsiveClass }}">
  {% endif %}

  {# Table #}
  <table class="{{ o.tableClasses }}" data-bs-data-table-target="table" {{ this.renderHtmlAttributes(o.attrs) | raw }}>
    
    {# Caption #}
    {% if o.captionText %}
      <caption class="caption-{{ o.captionPosition }}">{{ o.captionText }}</caption>
    {% endif %}

    {# Table Head #}
    {% if not o.isEmpty or (o.isEmpty and not o.showEmptyState) %}
      <thead{% if o.theadClass %} class="{{ o.theadClass }}"{% endif %}>
        <tr{% if o.divider %} class="border-bottom-2"{% endif %}>
          
          {# Selection column #}
          {% if o.selectable %}
            <th scope="col" style="width: 40px;">
              {% if o.selectAll %}
                <input 
                  type="checkbox" 
                  class="form-check-input" 
                  data-bs-data-table-target="selectAll"
                  data-action="change->bs-data-table#toggleSelectAll"
                  aria-label="Select all rows"
                >
              {% endif %}
            </th>
          {% endif %}

          {# Actions column at start #}
          {% if o.showActions and o.actionsPosition == 'start' %}
            <th scope="col">{{ o.actionsLabel }}</th>
          {% endif %}

          {# Data columns #}
          {% for column in o.columns %}
            <th 
              scope="col"
              {% if column.headerClass %} class="{{ column.headerClass }}"{% endif %}
              {% if column.align %} class="text-{{ column.align }}"{% endif %}
              {% if o.sortable and column.sortable %}data-sortable data-column="{{ loop.index0 }}"{% endif %}
            >
              {% if o.sortable and column.sortable %}
                <a 
                  href="#" 
                  class="text-decoration-none text-reset" 
                  data-action="click->bs-data-table#sort"
                  data-column="{{ loop.index0 }}"
                >
                  {{ column.label }}
                  <span class="sort-icon ms-1">â‡…</span>
                </a>
              {% else %}
                {{ column.label }}
              {% endif %}
            </th>
          {% endfor %}

          {# Actions column at end #}
          {% if o.showActions and o.actionsPosition == 'end' %}
            <th scope="col">{{ o.actionsLabel }}</th>
          {% endif %}

        </tr>
      </thead>
    {% endif %}

    {# Table Body #}
    <tbody data-bs-data-table-target="tbody">
      {% if o.isEmpty and o.showEmptyState %}
        {# Empty state #}
        <tr>
          <td 
            colspan="{{ 
              (o.columns|length) + 
              (o.selectable ? 1 : 0) + 
              (o.showActions ? 1 : 0) 
            }}" 
            class="text-center py-5 text-muted"
          >
            <div class="d-flex flex-column align-items-center gap-3">
              <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-inbox" viewBox="0 0 16 16">
                <path d="M4.98 4a.5.5 0 0 0-.39.188L1.54 8H6a.5.5 0 0 1 .5.5 1.5 1.5 0 1 0 3 0A.5.5 0 0 1 10 8h4.46l-3.05-3.812A.5.5 0 0 0 11.02 4H4.98zm9.954 5H10.45a2.5 2.5 0 0 1-4.9 0H1.066l.32 2.562a.5.5 0 0 0 .497.438h12.234a.5.5 0 0 0 .496-.438L14.933 9zM3.809 3.563A1.5 1.5 0 0 1 4.981 3h6.038a1.5 1.5 0 0 1 1.172.563l3.7 4.625a.5.5 0 0 1 .105.374l-.39 3.124A1.5 1.5 0 0 1 14.117 13H1.883a1.5 1.5 0 0 1-1.489-1.314l-.39-3.124a.5.5 0 0 1 .106-.374l3.7-4.625z"/>
              </svg>
              <div>{{ o.emptyMessage }}</div>
            </div>
          </td>
        </tr>
      {% else %}
        {# Data rows #}
        {% for row in o.rows %}
          <tr>
            
            {# Selection column #}
            {% if o.selectable %}
              <td>
                <input 
                  type="checkbox" 
                  class="form-check-input row-select" 
                  name="{{ o.selectName }}" 
                  value="{{ row.id ?? loop.index }}"
                  aria-label="Select row {{ loop.index }}"
                >
              </td>
            {% endif %}

            {# Actions column at start #}
            {% if o.showActions and o.actionsPosition == 'start' %}
              <td>
                {% block actions_start %}{% endblock %}
              </td>
            {% endif %}

            {# Data columns #}
            {% for column in o.columns %}
              <td
                {% if column.class %} class="{{ column.class }}"{% endif %}
                {% if column.align %} class="text-{{ column.align }}"{% endif %}
              >
                {% if column.formatter is not null %}
                  {{ column.formatter(row[column.key] ?? null, row) | raw }}
                {% else %}
                  {{ row[column.key] ?? '' }}
                {% endif %}
              </td>
            {% endfor %}

            {# Actions column at end #}
            {% if o.showActions and o.actionsPosition == 'end' %}
              <td>
                {% block actions_end %}{% endblock %}
              </td>
            {% endif %}

          </tr>
        {% endfor %}
      {% endif %}
    </tbody>

    {# Optional Table Footer #}
    {% block tfoot %}{% endblock %}

  </table>

  {# Close responsive wrapper #}
  {% if o.responsiveClass %}
    </div>
  {% endif %}

  {# Pagination #}
  {% if o.sortable or o.selectable %}
    <div class="d-flex justify-content-center mt-3" data-bs-data-table-target="pagination"></div>
  {% endif %}

  {# Close card wrapper #}
  {% if o.cardWrapper %}
      </div>
    </div>
  {% elseif o.wrapperClasses %}
    </div>
  {% endif %}

  {# Close container wrapper #}
  {% if o.containerClasses %}
    </div>
  {% endif %}
  
  </div>{# Close main controller wrapper #}

{%- endapply %}

